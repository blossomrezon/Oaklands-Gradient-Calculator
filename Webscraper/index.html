<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Oaklands Gradient Tool</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
/* ═══════════════════════════════════════════
   ROOT AND RESET
═══════════════════════════════════════════ */
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}

:root{
  --bg:        #0d0d0f;
  --surface:   #141416;
  --panel:     #1a1a1e;
  --border:    #2a2a30;
  --border2:   #363640;
  --text:      #e8e8f0;
  --muted:     #6b6b7e;
  --accent:    #7c6af7;
  --accent2:   #f76a8a;
  --accent3:   #6af7c8;
  --warn:      #f7a06a;
  --chip-bg:   #212128;
  --radius:    10px;
  --mono:      'JetBrains Mono', monospace;
  --sans:      'Syne', sans-serif;
}

html{scroll-behavior:smooth}
body{
  background:var(--bg);
  color:var(--text);
  font-family:var(--sans);
  min-height:100vh;
  overflow-x:hidden;
}

/* ═══════════════════════════════════════════
   NOISE OVERLAY
═══════════════════════════════════════════ */
body::before{
  content:'';
  position:fixed;inset:0;
  background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.04'/%3E%3C/svg%3E");
  pointer-events:none;z-index:0;opacity:.4;
}

/* ═══════════════════════════════════════════
   CRYING LAYOUT
═══════════════════════════════════════════ */
.app{
  position:relative;z-index:1;
  max-width:1100px;
  margin:0 auto;
  padding:40px 24px 80px;
}

/* ═══════════════════════════════════════════
   HEADER
═══════════════════════════════════════════ */
header{
  display:flex;align-items:flex-end;justify-content:space-between;
  margin-bottom:40px;
  padding-bottom:24px;
  border-bottom:1px solid var(--border);
}
.logo{
  display:flex;flex-direction:column;gap:4px;
}
.logo-tag{
  font-family:var(--mono);
  font-size:10px;
  color:var(--accent);
  letter-spacing:.15em;
  text-transform:uppercase;
}
h1{
  font-size:clamp(22px,4vw,34px);
  font-weight:800;
  line-height:1;
  letter-spacing:-.02em;
  background:linear-gradient(135deg,var(--text) 40%,var(--muted));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;
}
.header-actions{display:flex;gap:10px;align-items:center}

/* ═══════════════════════════════════════════
   BUTTONS UGH
═══════════════════════════════════════════ */
.btn{
  font-family:var(--sans);
  font-size:12px;font-weight:600;
  padding:8px 16px;
  border-radius:var(--radius);
  border:1px solid var(--border2);
  background:var(--panel);
  color:var(--text);
  cursor:pointer;
  transition:all .15s;
  letter-spacing:.04em;
  white-space:nowrap;
}
.btn:hover{background:var(--border);border-color:var(--accent);color:var(--accent)}
.btn-accent{
  background:var(--accent);border-color:var(--accent);
  color:#fff;
}
.btn-accent:hover{background:#9080ff;border-color:#9080ff;color:#fff}
.btn-sm{padding:5px 10px;font-size:11px}
.btn-danger{border-color:#f76a6a44}
.btn-danger:hover{border-color:#f76a6a;color:#f76a6a;background:var(--panel)}

/* ═══════════════════════════════════════════
   GRID
═══════════════════════════════════════════ */
.grid{
  display:grid;
  grid-template-columns:320px 1fr;
  gap:20px;
  align-items:start;
}
@media(max-width:760px){.grid{grid-template-columns:1fr}}

/* ═══════════════════════════════════════════
   PANELS
═══════════════════════════════════════════ */
.panel{
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:14px;
  padding:20px;
}
.panel-title{
  font-size:10px;font-weight:700;
  color:var(--muted);
  letter-spacing:.12em;
  text-transform:uppercase;
  margin-bottom:14px;
}

/* ═══════════════════════════════════════════
   SEARCH UGHHHHHHHHHHHH
═══════════════════════════════════════════ */
.search-wrap{position:relative;margin-bottom:12px}
.search-wrap input{
  width:100%;
  background:var(--surface);
  border:1px solid var(--border2);
  border-radius:var(--radius);
  padding:10px 14px 10px 38px;
  font-family:var(--sans);
  font-size:13px;
  color:var(--text);
  outline:none;
  transition:border-color .15s;
}
.search-wrap input:focus{border-color:var(--accent)}
.search-wrap input::placeholder{color:var(--muted)}
.search-icon{
  position:absolute;left:12px;top:50%;transform:translateY(-50%);
  color:var(--muted);font-size:14px;pointer-events:none;
}
.search-results{
  position:absolute;top:calc(100% + 4px);left:0;right:0;
  background:var(--surface);
  border:1px solid var(--border2);
  border-radius:var(--radius);
  max-height:220px;overflow-y:auto;
  z-index:100;
  display:none;
}
.search-results.open{display:block}
.search-result-item{
  display:flex;align-items:center;gap:10px;
  padding:8px 12px;
  cursor:pointer;
  transition:background .1s;
  font-size:12px;
}
.search-result-item:hover,.search-result-item.active{background:var(--border)}
.search-result-item img{
  width:28px;height:28px;
  border-radius:4px;
  object-fit:cover;
  flex-shrink:0;
  background:var(--border);
}
.result-name{flex:1;font-size:12px}
.result-badge{
  font-family:var(--mono);font-size:9px;
  color:var(--muted);
}

/* ═══════════════════════════════════════════
   SELECTED CHIPS I HATE THIS
═══════════════════════════════════════════ */
.chips{
  display:flex;flex-wrap:wrap;gap:6px;
  min-height:36px;
  margin-bottom:4px;
}
.chip{
  display:flex;align-items:center;gap:6px;
  background:var(--chip-bg);
  border:1px solid var(--border2);
  border-radius:8px;
  padding:4px 8px 4px 5px;
  font-size:11px;
  cursor:default;
  animation:chipIn .15s ease;
  position:relative;
}
@keyframes chipIn{from{opacity:0;transform:scale(.92)}to{opacity:1;transform:scale(1)}}
.chip img{
  width:22px;height:22px;
  border-radius:3px;
  object-fit:cover;
  background:var(--border);
}
.chip-name{font-size:11px;max-width:100px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.chip-star{cursor:pointer;font-size:12px;color:var(--muted);transition:color .1s}
.chip-star.on{color:var(--warn)}
.chip-star:hover{color:var(--warn)}
.chip-del{
  cursor:pointer;color:var(--muted);
  font-size:14px;line-height:1;
  transition:color .1s;
  margin-left:2px;
}
.chip-del:hover{color:var(--accent2)}
.chip-order{
  font-family:var(--mono);font-size:9px;
  color:var(--muted);
  min-width:14px;text-align:center;
}

/* ═══════════════════════════════════════════
   CONTROLS MY SANITY IS GONEEE
═══════════════════════════════════════════ */
.control-row{
  display:flex;align-items:center;justify-content:space-between;
  padding:10px 0;
  border-bottom:1px solid var(--border);
  gap:12px;
}
.control-row:last-child{border-bottom:none}
.control-label{font-size:12px;color:var(--muted);flex:1}
.control-label strong{color:var(--text);display:block;font-size:13px;font-weight:600}

input[type=number]{
  background:var(--surface);
  border:1px solid var(--border2);
  border-radius:6px;
  padding:6px 10px;
  font-family:var(--mono);
  font-size:13px;
  color:var(--text);
  width:72px;
  outline:none;
  text-align:center;
  transition:border-color .15s;
}
input[type=number]:focus{border-color:var(--accent)}

input[type=range]{
  -webkit-appearance:none;
  height:4px;
  border-radius:2px;
  background:var(--border2);
  outline:none;
  flex:1;
  cursor:pointer;
}
input[type=range]::-webkit-slider-thumb{
  -webkit-appearance:none;
  width:16px;height:16px;
  border-radius:50%;
  background:var(--accent);
  border:2px solid var(--bg);
  cursor:pointer;
  transition:transform .1s;
}
input[type=range]::-webkit-slider-thumb:hover{transform:scale(1.2)}

.range-labels{
  display:flex;justify-content:space-between;
  font-family:var(--mono);font-size:9px;
  color:var(--muted);margin-top:4px;
}
.range-val{
  font-family:var(--mono);font-size:11px;
  color:var(--accent);
  min-width:32px;text-align:right;
}

/* Toggle */
.toggle{
  position:relative;width:38px;height:20px;
  flex-shrink:0;
}
.toggle input{opacity:0;width:0;height:0}
.toggle-track{
  position:absolute;inset:0;
  background:var(--border2);border-radius:10px;
  cursor:pointer;transition:background .2s;
}
.toggle-track::after{
  content:'';
  position:absolute;
  width:14px;height:14px;
  border-radius:50%;
  background:var(--muted);
  top:3px;left:3px;
  transition:all .2s;
}
.toggle input:checked+.toggle-track{background:var(--accent)}
.toggle input:checked+.toggle-track::after{
  transform:translateX(18px);
  background:#fff;
}

/* ═══════════════════════════════════════════
   FILTER CHECKBOX THINGIES
═══════════════════════════════════════════ */
.filter-grid{
  display:flex;flex-wrap:wrap;gap:6px;
  margin-top:4px;
}
.filter-tag{
  display:flex;align-items:center;gap:5px;
  background:var(--chip-bg);
  border:1px solid var(--border2);
  border-radius:6px;
  padding:4px 9px;
  font-size:11px;
  cursor:pointer;
  transition:all .1s;
  user-select:none;
}
.filter-tag input{display:none}
.filter-tag.checked{
  background:#7c6af720;
  border-color:var(--accent);
  color:var(--accent);
}
.filter-dot{
  width:7px;height:7px;
  border-radius:50%;
  background:var(--muted);
  transition:background .1s;
}
.filter-tag.checked .filter-dot{background:var(--accent)}

/* ═══════════════════════════════════════════
   FAVORITES YAYYY
═══════════════════════════════════════════ */
.fav-list{
  display:flex;flex-wrap:wrap;gap:6px;
  min-height:24px;
}
.fav-chip{
  display:flex;align-items:center;gap:5px;
  background:var(--chip-bg);
  border:1px solid #f7a06a33;
  border-radius:6px;
  padding:3px 8px 3px 5px;
  font-size:11px;
  cursor:pointer;
  transition:border-color .1s;
}
.fav-chip:hover{border-color:var(--warn)}
.fav-chip img{width:18px;height:18px;border-radius:3px;object-fit:cover;background:var(--border)}
.fav-chip-name{font-size:10px}

/* ═══════════════════════════════════════════
   GRADIENT OUTPUT SLAYYY
═══════════════════════════════════════════ */
.output-section{
  margin-top:0;
}
.gradient-wrap{
  position:relative;
  border-radius:12px;
  overflow:hidden;
  border:1px solid var(--border);
  background:var(--surface);
}
.gradient-bar{
  display:flex;
  flex-direction:row;
  height:80px;
  width:100%;
  transition:all .2s;
}
.gradient-bar .seg{
  flex:1;min-width:0;min-height:0;
  height:100%;width:auto;
  position:relative;
  display:flex;flex-direction:column;justify-content:flex-end;
  overflow:hidden;cursor:pointer;
  transition:flex .3s ease;
}
.gradient-bar .seg:hover{flex:2.5}
.gradient-bar .seg-label{
  position:relative;z-index:2;
  padding:4px 6px;
  background:rgba(0,0,0,.7);
  font-family:var(--mono);font-size:9px;
  color:rgba(255,255,255,.85);
  line-height:1.3;opacity:0;
  transition:opacity .2s;
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
}
.gradient-bar .seg:hover .seg-label{opacity:1}
.gradient-bar.vertical{
  flex-direction:column;
  height:auto;width:100%;
}
.gradient-bar.vertical .seg{
  flex:1;min-height:36px;
  min-width:0;width:100%;height:auto;
  flex-direction:row;align-items:center;justify-content:flex-start;
}
.gradient-bar.vertical .seg:hover{flex:3}
.gradient-bar.vertical .seg-label{
  position:relative;z-index:2;
  padding:5px 10px;
  background:none;
  font-family:var(--mono);font-size:10px;
  color:rgba(255,255,255,.9);
  line-height:1.3;opacity:0;
  transition:opacity .2s;
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
  text-shadow:0 1px 4px rgba(0,0,0,.9);
}
.gradient-bar.vertical .seg:hover .seg-label{opacity:1}
.seg-texture{
  position:absolute;inset:0;
  background-size:cover;background-position:center;
  opacity:.55;transition:opacity .2s;
}
.seg:hover .seg-texture{opacity:.8}
.seg-color{position:absolute;inset:0;mix-blend-mode:multiply;}
.orient-btns{display:flex;gap:6px}
.orient-btn{
  font-family:var(--sans);font-size:11px;font-weight:600;
  padding:5px 12px;border-radius:6px;
  border:1px solid var(--border2);
  background:var(--surface);color:var(--muted);
  cursor:pointer;transition:all .15s;
}
.orient-btn.active{background:#7c6af720;border-color:var(--accent);color:var(--accent);}

/* ═══════════════════════════════════════════
   FULL VIEWER LIST THING
═══════════════════════════════════════════ */
.full-list{
  margin-top:12px;
  display:flex;
  flex-direction:column;
  gap:4px;
}
.list-row{
  display:flex;
  align-items:center;
  gap:10px;
  padding:8px 12px;
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:8px;
  animation:rowIn .2s ease;
}
@keyframes rowIn{from{opacity:0;transform:translateX(-6px)}to{opacity:1;transform:translateX(0)}}
.list-row-num{
  font-family:var(--mono);font-size:10px;
  color:var(--muted);min-width:24px;
}
.list-row-thumb{
  width:32px;height:32px;
  border-radius:4px;
  object-fit:cover;
  background:var(--border);
  flex-shrink:0;
}
.list-row-info{flex:1;min-width:0}
.list-row-name{font-size:12px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.list-row-type{font-family:var(--mono);font-size:9px;color:var(--muted);margin-top:1px}
.dist-bars{display:flex;flex-direction:column;gap:3px;width:120px}
.dist-bar-wrap{display:flex;align-items:center;gap:5px}
.dist-bar-label{font-family:var(--mono);font-size:8px;color:var(--muted);width:14px;text-align:right}
.dist-bar-track{flex:1;height:3px;background:var(--border2);border-radius:2px;overflow:hidden}
.dist-bar-fill{height:100%;border-radius:2px;transition:width .3s}
.dist-c{background:var(--accent)}
.dist-t{background:var(--accent3)}
.list-row-score{
  font-family:var(--mono);font-size:10px;
  color:var(--muted);
  min-width:36px;text-align:right;
}
.endpoint-badge{
  font-family:var(--mono);font-size:8px;
  padding:2px 5px;
  border-radius:4px;
  background:#7c6af720;
  color:var(--accent);
  border:1px solid var(--accent);
  flex-shrink:0;
}

/* ═══════════════════════════════════════════
   if empty make 2
═══════════════════════════════════════════ */
.empty{
  text-align:center;
  padding:48px 20px;
  color:var(--muted);
}
.empty-icon{font-size:36px;margin-bottom:12px;opacity:.4}
.empty p{font-size:13px;line-height:1.6}

/* ═══════════════════════════════════════════
   IMPORT AND EXPORT
═══════════════════════════════════════════ */
.io-row{
  display:flex;gap:8px;
  margin-top:20px;
  flex-wrap:wrap;
}

/* ═══════════════════════════════════════════
   TOOLTIP SLAYYYYY
═══════════════════════════════════════════ */
.tooltip{
  position:fixed;
  background:var(--surface);
  border:1px solid var(--border2);
  border-radius:8px;
  padding:10px 13px;
  font-size:11px;
  pointer-events:none;
  z-index:999;
  max-width:200px;
  display:none;
  box-shadow:0 8px 32px rgba(0,0,0,.4);
}
.tooltip.show{display:block}
.tooltip-name{font-size:13px;font-weight:700;margin-bottom:6px}
.tooltip-img{
  width:100%;aspect-ratio:1;
  object-fit:cover;border-radius:5px;
  margin-bottom:7px;
  background:var(--border);
}
.tooltip-row{
  display:flex;justify-content:space-between;
  font-family:var(--mono);font-size:9px;
  color:var(--muted);margin-top:3px;
}
.tooltip-row span:last-child{color:var(--text)}

/* ═══════════════════════════════════════════
   bottom right corner bs
═══════════════════════════════════════════ */
.notif{
  position:fixed;bottom:24px;right:24px;
  background:var(--panel);
  border:1px solid var(--border2);
  border-radius:10px;
  padding:12px 18px;
  font-size:12px;
  z-index:999;
  transform:translateY(80px);
  opacity:0;
  transition:all .3s cubic-bezier(.34,1.56,.64,1);
  max-width:260px;
  border-left:3px solid var(--accent);
}
.notif.show{transform:translateY(0);opacity:1}
.notif.error{border-left-color:var(--accent2)}
.notif.success{border-left-color:var(--accent3)}

/* ═══════════════════════════════════════════
   scrolling
═══════════════════════════════════════════ */
::-webkit-scrollbar{width:6px;height:6px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:3px}
::-webkit-scrollbar-thumb:hover{background:var(--muted)}

/* ═══════════════════════════════════════════
   LOADING
═══════════════════════════════════════════ */
#loading{
  position:fixed;inset:0;
  background:var(--bg);
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  z-index:9999;
  gap:16px;
  transition:opacity .4s;
}
.spinner{
  width:36px;height:36px;
  border:3px solid var(--border2);
  border-top-color:var(--accent);
  border-radius:50%;
  animation:spin .7s linear infinite;
}
@keyframes spin{to{transform:rotate(360deg)}}
#loading p{font-size:12px;color:var(--muted)}
</style>
</head>
<body>

<!-- LOADING SCREEN -->
<div id="loading">
  <div class="spinner"></div>
  <p>Loading materials…</p>
</div>

<!-- TOOLTIP -->
<div class="tooltip" id="tooltip">
  <img class="tooltip-img" id="tt-img" src="" alt="">
  <div class="tooltip-name" id="tt-name"></div>
  <div class="tooltip-row"><span>L</span><span id="tt-L"></span></div>
  <div class="tooltip-row"><span>a</span><span id="tt-a"></span></div>
  <div class="tooltip-row"><span>b</span><span id="tt-b"></span></div>
  <div class="tooltip-row"><span>contrast</span><span id="tt-contrast"></span></div>
  <div class="tooltip-row"><span>frequency</span><span id="tt-freq"></span></div>
</div>

<!-- NOTIFICATION -->
<div class="notif" id="notif"></div>

<div class="app">

  <!-- HEADER -->
  <header>
    <div class="logo">
      <span class="logo-tag">Oaklands · Material Tool</span>
      <h1>Gradient Calculator</h1>
    </div>
    <div class="header-actions">
      <button class="btn btn-sm" onclick="importGradient()">⬆ Import</button>
      <button class="btn btn-sm btn-accent" onclick="exportGradient()">⬇ Export</button>
    </div>
  </header>

  <div class="grid">

    <!-- LEFT PANEL: INPUTS -->
    <div>

      <!-- SEARCH -->
      <div class="panel" style="margin-bottom:16px">
        <div class="panel-title">Material Selection</div>
        <div class="search-wrap">
          <span class="search-icon">⌕</span>
          <input type="text" id="search" placeholder="Search and press Enter to add…" autocomplete="off">
          <div class="search-results" id="searchResults"></div>
        </div>
        <div class="chips" id="chips">
          <span style="font-size:11px;color:var(--muted);align-self:center">No materials selected yet</span>
        </div>
      </div>

      <!-- CONTROLS -->
      <div class="panel" style="margin-bottom:16px">
        <div class="panel-title">Controls</div>

        <div class="control-row">
          <div class="control-label">
            <strong>Materials In-Between</strong>
            <span>Per segment pair</span>
          </div>
          <input type="number" id="steps" value="5" min="2" max="100">
        </div>

        <div class="control-row">
          <div class="control-label">
            <strong>Lock Endpoints</strong>
            <span>Keep first & last fixed</span>
          </div>
          <label class="toggle">
            <input type="checkbox" id="lockEndpoints" checked>
            <span class="toggle-track"></span>
          </label>
        </div>

        <div class="control-row" style="flex-direction:column;align-items:stretch;gap:8px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div class="control-label" style="flex:none">
              <strong>Color ↔ Texture Weight</strong>
            </div>
            <div style="display:flex;gap:6px;align-items:center">
              <span style="font-family:var(--mono);font-size:9px;color:var(--accent)">COLOR</span>
              <span class="range-val" id="weightVal">70%</span>
              <span style="font-family:var(--mono);font-size:9px;color:var(--accent3)">TEX</span>
            </div>
          </div>
          <input type="range" id="weight" min="0" max="100" value="70">
          <div class="range-labels"><span>All Color</span><span>All Texture</span></div>
        </div>

        <div class="control-row" style="flex-direction:column;align-items:stretch;gap:8px">
          <div class="control-label"><strong>Segment Width</strong></div>
          <input type="range" id="segWidth" min="40" max="200" value="80">
          <div class="range-labels"><span>Narrow</span><span>Wide</span></div>
        </div>

        <div class="control-row">
          <div class="control-label">
            <strong>Prevent Repeats</strong>
            <span>Skip duplicate materials</span>
          </div>
          <label class="toggle">
            <input type="checkbox" id="noRepeat" checked>
            <span class="toggle-track"></span>
          </label>
        </div>

      </div>

      <!-- FILTERS -->
      <div class="panel" style="margin-bottom:16px">
        <div class="panel-title">Exclude Material Types</div>
        <div class="filter-grid" id="filterGrid"></div>
      </div>

      <!-- FAVORITES -->
      <div class="panel">
        <div class="panel-title">⭐ Favorites</div>
        <div class="fav-list" id="favList">
          <span style="font-size:11px;color:var(--muted)">No favorites yet — star a material to save it</span>
        </div>
      </div>

    </div>

    <!-- RIGHT PANEL: OUTPUT -->
    <div class="output-section">
      <div class="panel">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px">
          <div class="panel-title" style="margin-bottom:0">Gradient Output</div>
          <div style="display:flex;gap:8px;align-items:center">
            <div class="orient-btns">
              <button class="orient-btn active" id="orientH" onclick="setOrientation('horizontal')">⟷ H</button>
              <button class="orient-btn" id="orientV" onclick="setOrientation('vertical')">↕ V</button>
            </div>
            <button class="btn btn-sm" id="btnClear" onclick="clearSelected()">Clear</button>
            <button class="btn btn-sm btn-accent" onclick="buildGradient()">Rebuild</button>
          </div>
        </div>

        <div class="gradient-wrap">
          <div class="gradient-bar" id="gradientBar"></div>
        </div>

        <div class="full-list" id="fullList">
          <div class="empty">
            <div class="empty-icon">◈</div>
            <p>Select two or more materials<br>to generate a gradient</p>
          </div>
        </div>

      </div>
    </div>

  </div>
</div>

<input type="file" id="importFile" accept=".json" style="display:none" onchange="handleImport(event)">

<script>
// ═══════════════════════════════════════════════════════
//  STATE
// ═══════════════════════════════════════════════════════
let materials   = []          // full dataset
let selected    = []          // ordered array of selected material objects
let favorites   = new Set()   // material names
let gradientResult = []       // last built gradient
let searchIdx   = -1          // keyboard nav index

const FILTER_TYPES = ['Fabric','Metal','Glass','Dyed','Limited','Rock','Wood','Planked','Sanded','Refined','Forged']
let excludedTypes = new Set()

// ═══════════════════════════════════════════════════════
//  INIT
// ═══════════════════════════════════════════════════════
async function init(){
  try{
    const r = await fetch('materials.json')
    if(!r.ok) throw new Error(`HTTP ${r.status}`)
    materials = await r.json()
    restoreSession()
    renderFilters()
    renderFavs()
    buildGradient()
    // hide loading
    const el = document.getElementById('loading')
    el.style.opacity = '0'
    setTimeout(()=>el.style.display='none', 400)
    notify(`Loaded ${materials.length} materials`, 'success')
  }catch(e){
    document.getElementById('loading').innerHTML =
      `<div style="color:#f76a6a;text-align:center;padding:20px">
        <div style="font-size:24px;margin-bottom:12px">✕</div>
        <strong>Could not load materials.json</strong><br>
        <span style="font-size:12px;color:var(--muted)">Make sure you ran enrich_materials.py first</span><br>
        <span style="font-family:var(--mono);font-size:10px;color:var(--muted);margin-top:8px;display:block">${e.message}</span>
      </div>`
  }
}

// ═══════════════════════════════════════════════════════
//  PERCEPTUAL DISTANCE
// ═══════════════════════════════════════════════════════
function colorDist(a, b){
  return Math.sqrt(
    (a.L-b.L)**2 +
    (a.a-b.a)**2 +
    (a.b-b.b)**2
  )
}

function textureDist(a, b){
  const dc = Math.abs((a.contrast||0) - (b.contrast||0))
  const dv = Math.abs((a.variance||0) - (b.variance||0))
  const df = Math.abs((a.frequency||0) - (b.frequency||0))
  // normalize: contrast/variance are 0-1, combine equally
  return (dc + dv + df) / 3
}

function blendedDist(a, b, colorW){
  // colorW: 0–1, higher = more color weight
  const cd = colorDist(a, b)
  const td = textureDist(a, b)
  return colorW * cd + (1 - colorW) * td
}

// ═══════════════════════════════════════════════════════
//  OKLAB INTERPOLATION
// ═══════════════════════════════════════════════════════
function lerpOklab(A, B, t){
  return {
    L: A.L + (B.L - A.L) * t,
    a: A.a + (B.a - A.a) * t,
    b: A.b + (B.b - A.b) * t,
    contrast:   (A.contrast||0)  + ((B.contrast||0)  - (A.contrast||0))  * t,
    variance:   (A.variance||0)  + ((B.variance||0)  - (A.variance||0))  * t,
    frequency:  (A.frequency||0) + ((B.frequency||0) - (A.frequency||0)) * t,
  }
}

function findClosest(target, pool, colorW){
  let best = null, bestD = Infinity
  for(const m of pool){
    const d = blendedDist(target, m, colorW)
    if(d < bestD){ bestD = d; best = m }
  }
  return {mat: best, dist: bestD}
}

// ═══════════════════════════════════════════════════════
//  BUILD GRADIENT
// ═══════════════════════════════════════════════════════
function buildGradient(){
  if(selected.length < 2){
    renderGradientBar([])
    renderFullList([])
    return
  }

  const steps    = Math.max(2, Math.min(100, parseInt(document.getElementById('steps').value)||5))
  const colorW   = parseInt(document.getElementById('weight').value) / 100
  const noRepeat = document.getElementById('noRepeat').checked

  // Build filtered pool
  const pool = materials.filter(m => {
    if(excludedTypes.size === 0) return true
    const name = m.name.toLowerCase()
    for(const ex of excludedTypes){
      if(name.includes(ex.toLowerCase())) return false
    }
    return true
  })

  const result = []
  const usedNames = new Set()

  for(let i = 0; i < selected.length - 1; i++){
    const A = selected[i]
    const B = selected[i+1]

    result.push({...A, _endpoint: true, _colorDist: 0, _texDist: 0})
    if(noRepeat) usedNames.add(A.name)

    for(let s = 1; s <= steps; s++){
      const t = s / (steps + 1)
      const target = lerpOklab(A, B, t)

      // Filter out already used if noRepeat
      const candidates = noRepeat
        ? pool.filter(m => !usedNames.has(m.name) && m.name !== A.name && m.name !== B.name)
        : pool.filter(m => m.name !== A.name && m.name !== B.name)

      if(candidates.length === 0) continue

      const {mat, dist: d} = findClosest(target, candidates, colorW)
      if(!mat) continue

      if(noRepeat) usedNames.add(mat.name)

      result.push({
        ...mat,
        _endpoint: false,
        _colorDist: colorDist(target, mat),
        _texDist:   textureDist(target, mat),
        _totalDist: d
      })
    }
  }

  // Last endpoint
  const last = selected[selected.length - 1]
  result.push({...last, _endpoint: true, _colorDist: 0, _texDist: 0})

  gradientResult = result
  renderGradientBar(result)
  renderFullList(result)
  saveSession()
}

// ═══════════════════════════════════════════════════════
//  RENDER GRADIENT BAR
// ═══════════════════════════════════════════════════════
function oklabToHex(L, a, b){
  // OKLab → Linear RGB → sRGB
  const l_ = L + 0.3963377774*a + 0.2158037573*b
  const m_ = L - 0.1055613458*a - 0.0638541728*b
  const s_ = L - 0.0894841775*a - 1.2914855480*b

  const l3 = l_*l_*l_, m3 = m_*m_*m_, s3 = s_*s_*s_

  let r = 4.0767416621*l3 - 3.3077115913*m3 + 0.2309699292*s3
  let g = -1.2684380046*l3 + 2.6097574011*m3 - 0.3413193965*s3
  let bv= -0.0041960863*l3 - 0.7034186147*m3 + 1.7076147010*s3

  function toSrgb(c){
    c = Math.max(0, Math.min(1, c))
    return Math.round((c <= 0.0031308 ? 12.92*c : 1.055*Math.pow(c,1/2.4)-0.055)*255)
  }

  const R = toSrgb(r), G = toSrgb(g), B = toSrgb(bv)
  return `#${R.toString(16).padStart(2,'0')}${G.toString(16).padStart(2,'0')}${B.toString(16).padStart(2,'0')}`
}

// ═══════════════════════════════════════════════════════
//  ORIENTATION
// ═══════════════════════════════════════════════════════
let gradientOrientation = 'horizontal'

function setOrientation(dir){
  gradientOrientation = dir
  document.getElementById('orientH').classList.toggle('active', dir==='horizontal')
  document.getElementById('orientV').classList.toggle('active', dir==='vertical')
  renderGradientBar(gradientResult)
}

function renderGradientBar(list){
  const bar = document.getElementById('gradientBar')
  const segW = parseInt(document.getElementById('segWidth').value)
  const isVertical = gradientOrientation === 'vertical'

  // Apply orientation class
  bar.classList.toggle('vertical', isVertical)

  if(list.length === 0){
    bar.innerHTML = `<div style="display:flex;align-items:center;justify-content:center;width:100%;height:80px;color:var(--muted);font-size:12px">Select materials to preview gradient</div>`
    return
  }

  bar.innerHTML = ''
  list.forEach(m => {
    const hex = oklabToHex(m.L, m.a, m.b)
    const seg = document.createElement('div')
    seg.className = 'seg'

    if(isVertical){
      // In vertical mode, segWidth slider controls height per segment
      seg.style.minHeight = Math.max(20, Math.round(segW * 0.4)) + 'px'
    } else {
      // In horizontal mode, segWidth controls min width
      seg.style.minWidth = segW + 'px'
      seg.style.maxWidth = (segW * 2) + 'px'
    }

    const texDiv = document.createElement('div')
    texDiv.className = 'seg-texture'
    if(m.image) texDiv.style.backgroundImage = `url('${m.image}')`
    else texDiv.style.background = hex

    const colDiv = document.createElement('div')
    colDiv.className = 'seg-color'
    colDiv.style.background = hex

    const label = document.createElement('div')
    label.className = 'seg-label'
    label.textContent = m.name.replace(/_/g,' ').replace(/ Texture$/i,'')

    seg.appendChild(texDiv)
    seg.appendChild(colDiv)
    seg.appendChild(label)

    // Hover tooltip
    seg.addEventListener('mouseenter', e => showTooltip(m, e))
    seg.addEventListener('mousemove',  e => moveTooltip(e))
    seg.addEventListener('mouseleave', hideTooltip)

    bar.appendChild(seg)
  })
}

// ═══════════════════════════════════════════════════════
//  RENDER FULL LIST
// ═══════════════════════════════════════════════════════
function renderFullList(list){
  const el = document.getElementById('fullList')
  if(list.length === 0){
    el.innerHTML = `<div class="empty"><div class="empty-icon">◈</div><p>Select two or more materials<br>to generate a gradient</p></div>`
    return
  }

  // Compute max dist for normalization
  const maxC = Math.max(...list.map(m => m._colorDist||0), .001)
  const maxT = Math.max(...list.map(m => m._texDist||0), .001)

  el.innerHTML = ''
  list.forEach((m, i) => {
    const row = document.createElement('div')
    row.className = 'list-row'

    const cleanName = m.name.replace(/_/g,' ').replace(/ Texture$/i,'')
    const hex = oklabToHex(m.L, m.a, m.b)
    const cPct = Math.round((m._colorDist||0) / maxC * 100)
    const tPct = Math.round((m._texDist||0)   / maxT * 100)

    row.innerHTML = `
      <div class="list-row-num">${i+1}</div>
      ${m.image
        ? `<img class="list-row-thumb" src="${m.image}" alt="${cleanName}" loading="lazy">`
        : `<div class="list-row-thumb" style="background:${hex};border-radius:4px"></div>`
      }
      <div class="list-row-info">
        <div class="list-row-name">${cleanName}</div>
        <div class="list-row-type" style="color:${hex}">${hex}</div>
      </div>
      <div class="dist-bars">
        <div class="dist-bar-wrap">
          <div class="dist-bar-label">C</div>
          <div class="dist-bar-track"><div class="dist-bar-fill dist-c" style="width:${cPct}%"></div></div>
        </div>
        <div class="dist-bar-wrap">
          <div class="dist-bar-label">T</div>
          <div class="dist-bar-track"><div class="dist-bar-fill dist-t" style="width:${tPct}%"></div></div>
        </div>
      </div>
      ${m._endpoint ? '<div class="endpoint-badge">PIN</div>' : '<div style="min-width:36px"></div>'}
    `

    row.addEventListener('mouseenter', e => showTooltip(m, e))
    row.addEventListener('mousemove',  e => moveTooltip(e))
    row.addEventListener('mouseleave', hideTooltip)

    el.appendChild(row)
  })
}

// ═══════════════════════════════════════════════════════
//  SEARCH
// ═══════════════════════════════════════════════════════
const searchInput = document.getElementById('search')
const searchResults = document.getElementById('searchResults')

searchInput.addEventListener('input', () => {
  const q = searchInput.value.trim().toLowerCase()
  if(!q){ searchResults.classList.remove('open'); return }

  const matches = materials
    .filter(m => m.name.toLowerCase().replace(/_/g,' ').includes(q))
    .slice(0, 12)

  if(!matches.length){ searchResults.classList.remove('open'); return }

  searchResults.innerHTML = ''
  matches.forEach((m, idx) => {
    const div = document.createElement('div')
    div.className = 'search-result-item'
    div.dataset.idx = idx

    const cleanName = m.name.replace(/_/g,' ').replace(/ Texture$/i,'')
    const isSelected = selected.some(s => s.name === m.name)

    div.innerHTML = `
      ${m.image
        ? `<img src="${m.image}" alt="${cleanName}" loading="lazy">`
        : `<div style="width:28px;height:28px;border-radius:4px;background:${oklabToHex(m.L,m.a,m.b)};flex-shrink:0"></div>`
      }
      <span class="result-name" style="${isSelected?'color:var(--accent)':''}">${cleanName}${isSelected?' ✓':''}</span>
      <span class="result-badge">${m.contrast?m.contrast.toFixed(2):'-'}</span>
    `
    div.addEventListener('mousedown', e => { e.preventDefault(); toggleMaterial(m) })
    searchResults.appendChild(div)
  })

  searchIdx = -1
  searchResults.classList.add('open')
})

searchInput.addEventListener('keydown', e => {
  const items = searchResults.querySelectorAll('.search-result-item')

  if(e.key === 'ArrowDown'){
    e.preventDefault()
    searchIdx = Math.min(searchIdx+1, items.length-1)
    items.forEach((el,i) => el.classList.toggle('active', i===searchIdx))
  } else if(e.key === 'ArrowUp'){
    e.preventDefault()
    searchIdx = Math.max(searchIdx-1, -1)
    items.forEach((el,i) => el.classList.toggle('active', i===searchIdx))
  } else if(e.key === 'Enter'){
    e.preventDefault()
    if(searchIdx >= 0 && items[searchIdx]){
      items[searchIdx].dispatchEvent(new MouseEvent('mousedown'))
    } else {
      const q = searchInput.value.trim().toLowerCase()
      const m = materials.find(m => m.name.toLowerCase().replace(/_/g,' ').includes(q))
      if(m) toggleMaterial(m)
    }
    searchInput.value = ''
    searchResults.classList.remove('open')
  } else if(e.key === 'Escape'){
    searchResults.classList.remove('open')
  }
})

document.addEventListener('click', e => {
  if(!e.target.closest('#search') && !e.target.closest('#searchResults'))
    searchResults.classList.remove('open')
})

// ═══════════════════════════════════════════════════════
//  MATERIAL TOGGLE
// ═══════════════════════════════════════════════════════
function toggleMaterial(m){
  const idx = selected.findIndex(s => s.name === m.name)
  if(idx >= 0){
    selected.splice(idx, 1)
    notify(`Removed: ${m.name.replace(/_/g,' ')}`)
  } else {
    selected.push(m)
    notify(`Added: ${m.name.replace(/_/g,' ')}`, 'success')
  }
  renderChips()
  buildGradient()
}

function clearSelected(){
  selected = []
  renderChips()
  buildGradient()
  notify('Cleared selection')
}

// ═══════════════════════════════════════════════════════
//  RENDER CHIPS
// ═══════════════════════════════════════════════════════
function renderChips(){
  const el = document.getElementById('chips')
  if(selected.length === 0){
    el.innerHTML = `<span style="font-size:11px;color:var(--muted);align-self:center">No materials selected yet</span>`
    return
  }
  el.innerHTML = ''
  selected.forEach((m, i) => {
    const cleanName = m.name.replace(/_/g,' ').replace(/ Texture$/i,'')
    const isFav = favorites.has(m.name)
    const hex = oklabToHex(m.L, m.a, m.b)

    const chip = document.createElement('div')
    chip.className = 'chip'
    chip.innerHTML = `
      <span class="chip-order">${i+1}</span>
      ${m.image
        ? `<img src="${m.image}" alt="${cleanName}">`
        : `<div style="width:22px;height:22px;border-radius:3px;background:${hex};flex-shrink:0"></div>`
      }
      <span class="chip-name">${cleanName}</span>
      <span class="chip-star ${isFav?'on':''}" onclick="toggleFav('${m.name}')" title="Favorite">★</span>
      <span class="chip-del" onclick="toggleMaterial(${JSON.stringify(m).replace(/"/g,'&quot;')})" title="Remove">×</span>
    `
    el.appendChild(chip)
  })
}

// ═══════════════════════════════════════════════════════
//  FAVORITES
// ═══════════════════════════════════════════════════════
function toggleFav(name){
  if(favorites.has(name)) favorites.delete(name)
  else favorites.add(name)
  renderChips()
  renderFavs()
  saveFavs()
}

function renderFavs(){
  const el = document.getElementById('favList')
  const favMats = materials.filter(m => favorites.has(m.name))
  if(favMats.length === 0){
    el.innerHTML = `<span style="font-size:11px;color:var(--muted)">No favorites yet — star a material to save it</span>`
    return
  }
  el.innerHTML = ''
  favMats.forEach(m => {
    const cleanName = m.name.replace(/_/g,' ').replace(/ Texture$/i,'')
    const div = document.createElement('div')
    div.className = 'fav-chip'
    div.title = `Click to add ${cleanName}`
    div.innerHTML = `
      ${m.image
        ? `<img src="${m.image}" alt="${cleanName}">`
        : `<div style="width:18px;height:18px;border-radius:3px;background:${oklabToHex(m.L,m.a,m.b)}"></div>`
      }
      <span class="fav-chip-name">${cleanName}</span>
    `
    div.addEventListener('click', () => toggleMaterial(m))
    el.appendChild(div)
  })
}

function saveFavs(){
  sessionStorage.setItem('oak_favs', JSON.stringify([...favorites]))
}

// ═══════════════════════════════════════════════════════
//  FILTERS
// ═══════════════════════════════════════════════════════
function renderFilters(){
  const grid = document.getElementById('filterGrid')
  grid.innerHTML = ''
  FILTER_TYPES.forEach(type => {
    const label = document.createElement('label')
    label.className = 'filter-tag'
    label.innerHTML = `
      <input type="checkbox">
      <div class="filter-dot"></div>
      ${type}
    `
    const cb = label.querySelector('input')
    cb.addEventListener('change', () => {
      if(cb.checked){ excludedTypes.add(type); label.classList.add('checked') }
      else { excludedTypes.delete(type); label.classList.remove('checked') }
      buildGradient()
    })
    grid.appendChild(label)
  })
}

// ═══════════════════════════════════════════════════════
//  TOOLTIP
// ═══════════════════════════════════════════════════════
const tooltip = document.getElementById('tooltip')
let ttTimeout

function showTooltip(m, e){
  clearTimeout(ttTimeout)
  ttTimeout = setTimeout(() => {
    document.getElementById('tt-img').src   = m.image || ''
    document.getElementById('tt-img').style.display = m.image ? 'block' : 'none'
    document.getElementById('tt-name').textContent  = m.name.replace(/_/g,' ').replace(/ Texture$/i,'')
    document.getElementById('tt-L').textContent     = (m.L||0).toFixed(4)
    document.getElementById('tt-a').textContent     = (m.a||0).toFixed(4)
    document.getElementById('tt-b').textContent     = (m.b||0).toFixed(4)
    document.getElementById('tt-contrast').textContent = (m.contrast||0).toFixed(3)
    document.getElementById('tt-freq').textContent     = (m.frequency||0).toFixed(3)
    tooltip.classList.add('show')
    moveTooltip(e)
  }, 120)
}

function moveTooltip(e){
  const tw = tooltip.offsetWidth, th = tooltip.offsetHeight
  let x = e.clientX + 14, y = e.clientY + 14
  if(x + tw > window.innerWidth  - 10) x = e.clientX - tw - 14
  if(y + th > window.innerHeight - 10) y = e.clientY - th - 14
  tooltip.style.left = x + 'px'
  tooltip.style.top  = y + 'px'
}

function hideTooltip(){
  clearTimeout(ttTimeout)
  tooltip.classList.remove('show')
}

// ═══════════════════════════════════════════════════════
//  NOTIFICATIONS
// ═══════════════════════════════════════════════════════
let notifTimeout
function notify(msg, type=''){
  const el = document.getElementById('notif')
  el.textContent = msg
  el.className   = `notif ${type} show`
  clearTimeout(notifTimeout)
  notifTimeout = setTimeout(() => el.classList.remove('show'), 2500)
}

// ═══════════════════════════════════════════════════════
//  SESSION STORAGE
// ═══════════════════════════════════════════════════════
function saveSession(){
  const state = {
    selected:  selected.map(m => m.name),
    steps:     document.getElementById('steps').value,
    weight:    document.getElementById('weight').value,
    noRepeat:  document.getElementById('noRepeat').checked,
    lockEP:    document.getElementById('lockEndpoints').checked,
    segWidth:  document.getElementById('segWidth').value,
    excluded:  [...excludedTypes],
    orientation: gradientOrientation
  }
  sessionStorage.setItem('oak_state', JSON.stringify(state))
}

function restoreSession(){
  // Restore favs first
  try{
    const favs = JSON.parse(sessionStorage.getItem('oak_favs') || '[]')
    favorites = new Set(favs)
  }catch(e){}

  try{
    const raw = sessionStorage.getItem('oak_state')
    if(!raw) return
    const s = JSON.parse(raw)

    if(s.selected){
      selected = s.selected
        .map(name => materials.find(m => m.name === name))
        .filter(Boolean)
    }
    if(s.steps)    document.getElementById('steps').value    = s.steps
    if(s.weight){
      document.getElementById('weight').value   = s.weight
      document.getElementById('weightVal').textContent = s.weight + '%'
    }
    if(s.noRepeat  !== undefined) document.getElementById('noRepeat').checked       = s.noRepeat
    if(s.lockEP    !== undefined) document.getElementById('lockEndpoints').checked  = s.lockEP
    if(s.segWidth)  document.getElementById('segWidth').value = s.segWidth
    if(s.excluded){
      excludedTypes = new Set(s.excluded)
    }
    if(s.orientation) setOrientation(s.orientation)

    renderChips()
  }catch(e){
    console.warn('Session restore failed:', e)
  }
}

// ═══════════════════════════════════════════════════════
//  IMPORT / EXPORT
// ═══════════════════════════════════════════════════════
function exportGradient(){
  if(gradientResult.length === 0){ notify('No gradient to export', 'error'); return }

  const pack = {
    version: 1,
    created: new Date().toISOString(),
    settings: {
      steps:    document.getElementById('steps').value,
      weight:   document.getElementById('weight').value,
      noRepeat: document.getElementById('noRepeat').checked,
      excluded: [...excludedTypes]
    },
    selection: selected.map(m => m.name),
    gradient:  gradientResult.map(m => ({
      name:      m.name,
      L: m.L, a: m.a, b: m.b,
      endpoint:  m._endpoint || false
    }))
  }

  const blob = new Blob([JSON.stringify(pack, null, 2)], {type:'application/json'})
  const url  = URL.createObjectURL(blob)
  const a    = document.createElement('a')
  a.href     = url
  a.download = `oaklands_gradient_${Date.now()}.json`
  a.click()
  URL.revokeObjectURL(url)
  notify('Exported gradient pack', 'success')
}

function importGradient(){
  document.getElementById('importFile').click()
}

function handleImport(e){
  const file = e.target.files[0]
  if(!file) return
  const reader = new FileReader()
  reader.onload = ev => {
    try{
      const pack = JSON.parse(ev.target.result)
      if(!pack.selection) throw new Error('Invalid format')

      // Restore settings
      if(pack.settings){
        if(pack.settings.steps)  document.getElementById('steps').value  = pack.settings.steps
        if(pack.settings.weight){
          document.getElementById('weight').value = pack.settings.weight
          document.getElementById('weightVal').textContent = pack.settings.weight + '%'
        }
        if(pack.settings.noRepeat !== undefined)
          document.getElementById('noRepeat').checked = pack.settings.noRepeat
        if(pack.settings.excluded){
          excludedTypes = new Set(pack.settings.excluded)
        }
      }

      // Restore selection
      selected = pack.selection
        .map(name => materials.find(m => m.name === name))
        .filter(Boolean)

      renderChips()
      buildGradient()
      notify(`Imported ${selected.length} materials`, 'success')
    }catch(err){
      notify('Import failed: ' + err.message, 'error')
    }
  }
  reader.readAsText(file)
  e.target.value = ''
}

// ═══════════════════════════════════════════════════════
//  EVENT LISTENERS (controls → rebuild)
// ═══════════════════════════════════════════════════════
document.getElementById('steps').addEventListener('change', () => {
  let v = parseInt(document.getElementById('steps').value)
  if(isNaN(v)||v<2) v=2
  if(v>100) v=100
  document.getElementById('steps').value = v
  buildGradient()
})

document.getElementById('weight').addEventListener('input', () => {
  document.getElementById('weightVal').textContent =
    document.getElementById('weight').value + '%'
  buildGradient()
})

document.getElementById('segWidth').addEventListener('input', () => {
  renderGradientBar(gradientResult)
})

document.getElementById('noRepeat').addEventListener('change', buildGradient)
document.getElementById('lockEndpoints').addEventListener('change', buildGradient)

// ═══════════════════════════════════════════════════════
//  KICK OFF
// ═══════════════════════════════════════════════════════
init()
</script>
</body>
</html>
